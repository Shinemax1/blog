---
title: 精读<<深入浅出Node.js.pdf>>
---

# 模块分类

## 核心模块

> node编译过程编译了二进制文件，之后在node启动时会直接加载在内存中，文件定位和编译执行这两个步骤会被省略掉，并且路径分析优先判断，加载速度是最快的。

### 编译过程

#### js核心模块

- node采用了v8附带的js2c.py工具，将所有（src/node.js和lib/*.js）js文件转换成C++里的数组。
- 过程中js以字符串的形式放在node的命名空间中，直到node进程启动，会被加载到内存中，之后找js核心模块会直接通过标识符分析直接定位到内存中，优先于文件模块。
- 和文件模块的区别在于，直接从内存中或者缓存执行结果中获取，process.binding('natives')，缓存结果放在NativeModule._cache而不是Module._cache

#### C++核心模块

- 所有的文件源代码会被放在node_module_list数组中，并被放在node命名空间中
- node进程执行时会被加载到内存，因为是二进制文件，不需要路径分析、文件定位、编译执行，直接可执行。取出可通过get_builtin_module在node_module_list数组中取出模块
- register_func将js2c.py转换成的字符串重新转换为js字符串

## 文件模块

> 是node运行时动态时加载，需要路径分析，文件定位，编译执行，速度慢于核心模块。

## 模块缓存

1. 浏览器缓存的是文件，node缓存的是编译执行的对象
2. 核心模块优先于文件模块
3. node不需要路径分析、文件定位、编译执行，直接从缓存对象中去

## 路径分析

- 直接找核心模块（fs、stream、http）
- 路径形式的文件模块（../、./）
- 自定义模块（通过node_modules往上找父文件）

## 文件定位

- 文件扩展名
  - node通过补充文件的后缀名（.js、.json、.node），定位文件。可以通过自己补充文件后缀达到优化文件模块加载速度的（.json、.node）。
